<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProjectList</title>
    <script src="https://kit.fontawesome.com/289a62abf7.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <style>
        .button_nw {
            background-color:rgba(255, 255, 255, 0);
            height:40px;
            width:250px;
            color:rgb(25, 25, 52);
            border: 1px solid rgba(0, 0, 0, 0.25);
            font-size: small;
            font-weight: 300;  
            margin-bottom: 10px;
            border-radius: 4px;
            font-family: 'Pretendard-Regular';
        }
        
        .modal_nw {
            width: 600px;           
            height: 600px;         
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border: 1px solid gray; /* 원본 유지 */
        }
        dialog.modal_nw::backdrop {
            background: rgba(0,0,0,0.4);
        }

        .box3{
            position: absolute;
            border: 1px solid gray;
            height: 800px;
            width: 1200px;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -30%);

            display: flex;  
            flex-direction: row;

            border-radius: 10px;
            background-color: white;
        }
        .box4{
            height: 100%;
            width: 100%;
            display: flex;  
            flex-direction: column;
            justify-content: flex-start;
            
            border-radius: 10px;
            border: none;
            background-color: rgb(255, 255, 255);
            
            padding: 15px;
        }
        .box5{
            background-color:rgba(255, 255, 255, 0);
            color:rgb(25, 25, 52);
            border: 1px solid rgba(0, 0, 0, 0.25);
            height: 200px;
            width: 250px;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: small;
            font-weight: 300; 
            font-family: 'Pretendard-Regular';
            border-radius: 4px;
        }

        .button_find {
            border: none;
            font-size: small;
            font-weight: 300;
            font-family: 'Pretendard-Regular';
            background-color: transparent; /* 원본 유지 */
        }
        input:focus {
            outline: none;
            background-color: rgb(245, 245, 245);
        }

        .find{
            background-color:rgba(255, 255, 255, 0);
            height:35px;
            width:200px;
            color:rgb(25, 25, 52);
            border: 1px solid rgba(0, 0, 0, 0.25); 

            padding: 10px;
            border-radius: 4px; 
        }
        .find:focus-within{
            outline: none;
            background-color: rgb(245, 245, 245);
        }
        
        .font7 {
            font-size: 10px;
            color: rgb(72, 72, 72);
            margin-left:5px;
            margin-top:auto;
            text-decoration: underline;
        }
        .main{
            height: 100%;
            width: 70%;
            box-sizing: border-box;
            border-right: solid 1px;
            display: flex;
            flex-direction: column;
        }
        .sub{
            height: 100%;
            width: 30%;

            display: flex;
            flex-direction: column;
        }
        .sub th{
            padding: 15px;
            height: 80px;
            display: flex;
            flex-direction: row;
            justify-content: flex-start;
            align-items: center;
        }

        .table1{
            width: 100%;
        }
        .table1:hover {
            background-color: rgb(241, 248, 247);
            border-radius: 10px;
        }
        .button_pj {
            background-color:rgb(183, 228, 206);
            border: none;
            height:45px;
            width:205px;
            color:rgb(25, 54, 52);
            font-size: medium;
            font-weight: 700;  
            border-radius: 4px;
            font-family: 'Pretendard-Regular';

            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .button_pj:hover {
            background-color: rgb(159, 211, 189);
        }
        .button_pj2 {
            background-color: white;
            border: solid 1px rgb(25, 54, 52);
            height:45px;
            width:205px;
            color:rgb(25, 54, 52);
            font-size: medium;
            font-weight: 700;  
            border-radius: 4px;
            font-family: 'Pretendard-Regular';

            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .button_yes {
            background-color: transparent;
            border: solid 1px rgb(112, 165, 139);          

            height:25px;
            width:50px;

            color:rgb(112, 165, 139);
            font-size: 15px;
            font-weight: 500;
            border-radius: 4px;
            font-family: 'Pretendard-Regular';
        }
        .button_yes:hover{
            background-color: rgb(112, 165, 139);
            color:white;
        }
        .button_yes:active{
            background-color: transparent;
            color:rgb(112, 165, 139);
        }
        .button_no {
            background-color: transparent;
            border: solid 1px rgb(173, 98, 98);          

            height:25px;
            width:50px;

            color:rgb(173, 98, 98);
            font-size: 15px;
            font-weight: 500;
            border-radius: 4px;
            font-family: 'Pretendard-Regular';
        }
        .button_no:hover{
            background-color: rgb(173, 98, 98);
            color:white;
        }
        .button_no:active{
            background-color: transparent;
            color:rgb(173, 98, 98);
        }
        .box_modal_nw{
            width: 100%;
            height: 100%;

            display: flex;
            flex-direction: column;
            justify-items: center;
            align-items: center;
        }

        .form-row {
            display: flex;
            flex-direction: row;
            gap: 10px;
            margin-bottom: 15px;
            width: 80%;
        }

        .form-row label {
            width: 120px;
            text-align: left;
            padding-top: 6px;
        }

        .form-row input,
        .form-row textarea {
            flex: 1;
            padding: 8px;
            box-sizing: border-box;
        }
        
    </style>
  <script type="module" crossorigin src="/assets/approot-BKkMt0Bv.js"></script>
  <link rel="stylesheet" crossorigin href="/css/bootstrap.CyjhP-aL.css">
  <link rel="stylesheet" crossorigin href="/css/styles.B5l9rU4X.css">
</head>

<body>
    <div id="root"></div>
    
    <dialog class="modal_nw">
        <div class="box_modal_nw" id="1">
            <div class="green">프로젝트 생성</div>
            <div style="width: 100%; margin-bottom: 30px;">
                <hr style="border: 1px solid rgb(0, 0, 0); "/>
            </div>
        
            <div class="form-row" style="gap: 10px;">
                <label for="projectTitle_modal">프로젝트 명</label>
                <input class="button_nw" type="text" id="projectTitle_modal" placeholder="프로젝트 명"/>
            </div>
            
            <div class="form-row" style="gap: 10px;">
                <label for="projectDescription_modal">프로젝트 설명</label>
                <textarea class="button_nw" id="projectDescription_modal" placeholder="프로젝트 설명" style="height: 330px; resize: vertical;"></textarea>
            </div>

            <!--
            <div style="margin-top:20px; display: flex; justify-content: center;">
                <button class="button_pj" style="width:80px; margin-right:5px;" onclick="addProject()">생성</button> <form method="dialog">
                    <button class="button_pj" style="background-color: rgb(184, 185, 186); width:80px;">취소</button>
                </form>
            </div>
            -->
            <div style="position: absolute; bottom: 20px; right: 20px; display: flex; flex-direction: row; justify-content: center; gap: 10px;">
                <button class="button_pj2" style="width:80px;" onclick="Watchdiv3('2')">다음</button>
                <form method="dialog">
                    <button class="button_pj2" style="background-color: rgb(220, 220, 220); border-color: gray; width:80px; color:rgb(50, 50, 50);">취소</button>
                </form>
            </div>

        </div>

        <div class="box_modal_nw" id="2">
            <div class="green">유저 초대</div>
            <div style="width: 100%; margin-bottom: 20px;">
                <hr style="border: 1px solid rgb(0, 0, 0); "/>
            </div>
                
            <div style="display: flex; flex-direction: row;">
                <div class="find3">
                    <input class="button_find3" type="text" id="find" placeholder="아이디 / 태그로 유저 검색" style="font-size: small; width: 400px;"/> 
                    <img src="icon/finding.png" style="width: 25px; height: 25px; margin: 5px; margin-left: auto;"/>                    
                </div>
                <div class="container_radio">
                    <input type="radio" name="option" style="height:15px; width:15px; margin: 5px;" checked="checked"><span>친구</span>
                    <input type="radio" name="option" style="height:15px; width:15px; margin: 5px; margin-left: 15px;"><span>전체</span>
                </div>             
            </div>
    
            <div class="box10">
            <div class="box_scroll">
                <table class="table table-hover" style="border-collapse: separate; border-spacing: 0;">
                    <thead>
                        <tr>
                            <th style="width: 55px;"></th>
                            <th style="width: 100px;">닉네임</th>
                            <th style="width: 100px;">아이디</th>
                            <th style="width: 60px;">#태그</th>
                            <th style="width: 50px;"></th>
                            <!-- <img src="icon/plus.png" style="height: 15px; width: 15px;"/> -->
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <img src="icon/user2.png" style="height: 30px; width: 30px; margin:5px;"/>
                            </td>
                            <td class="lenCut_container">
                                <span class="lenCut">닉네임이아주아주아주길어요</span>
                                <div class="tooltip1" id="tooltip"></div>                                                      
                            </td>
                            <td>
                                <div class="lenCut_container">
                                    <span class="lenCutE" style="font-size: small; color: rgba(0, 0, 0, 0.5);">identification123</span>                            
                                    <div class="tooltip1" id="tooltip"></div>                                        
                                </div>                            
                            </td>
                            <td>
                                <span style="color: #3a6b5b;">#0000</span>                               
                            </td>  
                            <td>
                                <button class="button_select">선택</button>
                            </td>                           
                        </tr>
                        <tr>
                            <td>
                                <img src="icon/user2.png" style="height: 30px; width: 30px; margin:5px;"/>
                            </td>
                            <td class="lenCut_container">
                                <span class="lenCut">정예은</span>
                                <div class="tooltip1" id="tooltip"></div>                                                      
                            </td>
                            <td>
                                <div class="lenCut_container">
                                    <span class="lenCutE" style="font-size: small; color: rgba(0, 0, 0, 0.5);">yeeun13</span>                            
                                    <div class="tooltip1" id="tooltip"></div>                                        
                                </div>                            
                            </td>
                            <td>
                                <span style="color: #3a6b5b;">#3697</span>                               
                            </td>  
                            <td>
                                <button class="button_select">선택</button>
                            </td>                           
                        </tr>
                    </tbody>
                </table>
            </div>
            </div>
            <br/>

            <div style="position: absolute; bottom: 20px; left: 20px; display: flex; flex-direction: row; justify-content: center; gap: 10px;">
                <button class="button_pj2" style="width:80px;" onclick="Watchdiv3('1')">이전</button>                
            </div>
            <div style="position: absolute; bottom: 20px; right: 20px; display: flex; flex-direction: row; justify-content: center; gap: 10px;">
                <button class="button_pj2" style="border-color: rgb(67, 126, 126); width:80px;" onclick="addProject()">완료</button>
                <form method="dialog">
                    <button class="button_pj2" style="background-color: rgb(220, 220, 220); border-color: gray; width:80px; color:rgb(50, 50, 50);; width:80px;">취소</button>
                </form>
            </div>
          </div>
        </div>
    </dialog>

    <div class="middle">
        <div class="box3">
            <div class="main">
                <div class="content_w" style="height: 60px; padding: 15px; border-bottom: solid 1px; border-color: rgba(163, 163, 163, 0.5);">
                    <div class="black" style="margin-right: auto; margin-left: 12px;">참여 프로젝트</div>

                    <div class="find" style="width: 30%; display: flex; align-items: center;">
                        <input class="button_find" type="text" id="find" placeholder="프로젝트 검색" style="font-size: small; width: 400px;"/> 
                        <img src="/finding.BUuyfvl0.png" style="width: 25px; height: 25px; margin: 5px"/>                     
                    </div>

                    <button class="button_pj" style="margin-left: auto;" id="addnewproject">새 프로젝트 생성</button> 
                </div>
                <div class="mid" style="background-color: rgb(245, 245, 245); padding: 15px;">
                    <div class="box4">
                        <table class="table table-hover"> 
                            <thead>
                                </thead>
                            <tbody id="tbody_pj">
                            </tbody>
                        </table>
                    </div>             
                </div>

            </div>

            <div class="sub">
                <div class="content_w" style="height: 60px; padding: 15px; border-bottom: solid 1px; border-color: rgba(163, 163, 163, 0.5);">
                    <div class="black" style="margin: 5px;">초대 요청 프로젝트</div>                
                </div>

                <div>
                    <table class="table">
                        <tbody id="tbody_invitepj">
                            </tbody>
                    </table>

                </div>

            </div>      

        </div>
    </div>
    
</body>
<script>
    function closeModal(dialog){
        dialog.addEventListener('click', function(e){
            if(e.target === dialog){
                dialog.close();
            }
        });
    }
    window.closeModal = closeModal;

    function openFindid() {
        window.open(
            'findid_pop.html',
            'Findid',
            'width=600,height=600,left=100,top=100'
        );
    }

    // 백엔드 API 호출하여 프로젝트 생성하는 함수로 수정
    async function addProject() {
        const titleInput = document.getElementById("projectTitle_modal"); // HTML 모달의 input id를 projectTitle_modal로 가정
        const descriptionInput = document.getElementById("projectDescription_modal"); // HTML 모달에 projectDescription_modal ID를 가진 textarea가 있다고 가정

        const title = titleInput.value.trim();
        const description = descriptionInput.value.trim();

        if (!title) {
            alert("프로젝트 명을 입력해주세요.");
            titleInput.focus();
            return;
        }

        const projectData = {
            title: title,
            description: description
        };

        try {
            const response = await fetch('/api/projects', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(projectData)
            });

            const result = await response.json();

            if (response.ok && result.status === 201) {
                alert(result.message || "프로젝트가 성공적으로 생성되었습니다.");

                const modal = document.querySelector(".modal_nw");
                if (modal) modal.close();

                titleInput.value = "";
                if(descriptionInput) descriptionInput.value = ""; // descriptionInput이 존재할 경우에만 초기화

                loadMyProjects();
            } else {
                alert(`프로젝트 생성 실패: ${result.message || '알 수 없는 오류'} (상태: ${response.status})`);
            }
        } catch (error) {
            console.error("Error during project creation:", error);
            alert("프로젝트 생성 중 오류가 발생했습니다. 네트워크 또는 서버 상태를 확인해주세요.");
        }
    }

    // 사용자의 프로젝트 목록을 불러와 화면에 표시하는 함수
    async function loadMyProjects() {
        const tbodyPj = document.getElementById("tbody_pj");
        if (!tbodyPj) return;
        tbodyPj.innerHTML = '<tr><td colspan="2" style="text-align:center; color:grey;">프로젝트 목록을 불러오는 중...</td></tr>';

        try {
            const response = await fetch('/api/projects', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                }
            });

            if (response.status === 401) {
                alert("로그인이 필요합니다. 로그인 페이지로 이동합니다.");
                window.location.href = "/front/login.html";
                return;
            }

            const result = await response.json();

            if (response.ok && result.status === 200) {
                const projects = result.data;
                tbodyPj.innerHTML = '';

                if (projects && projects.length > 0) {
                    projects.forEach(project => {
                        const tr = document.createElement("tr");
                        tr.onclick = () => goToProjectBoard(project.idx);
                        tr.innerHTML = `
                            <td style="width:30px;">
                                <img src="/icon/folder.png" style="height:20px; width:20px;"/>
                            </td>
                            <td style="font-size: medium; font-weight: 100; cursor:pointer;">${project.title}</td>
                        `;
                        tbodyPj.appendChild(tr);
                    });
                } else {
                    tbodyPj.innerHTML = '<tr><td colspan="2" style="text-align:center; color:grey;">참여 중인 프로젝트가 없습니다. 새 프로젝트를 생성해보세요!</td></tr>';
                }
            } else {
                tbodyPj.innerHTML = `<tr><td colspan="2" style="text-align:center; color:red;">프로젝트 목록을 불러오는 데 실패했습니다: ${result.message || '서버 오류'}</td></tr>`;
                console.error("Failed to load projects:", result.message);
            }
        } catch (error) {
            if(tbodyPj) tbodyPj.innerHTML = '<tr><td colspan="2" style="text-align:center; color:red;">프로젝트 목록 로드 중 네트워크 오류 발생.</td></tr>';
            console.error("Error loading projects:", error);
        }
    }

    // 프로젝트 보드로 이동하는 함수
    function goToProjectBoard(projectId) {
        if (projectId) {
            window.location.href = `projectboard.html?projectId=${projectId}`;
        }
    }

    // 초대된 프로젝트 목록 로드 (다음 단계에서 구현 - 현재는 원본 HTML의 구조만 유지)
    async function loadPendingInvitations() {
        const tbodyInvitePj = document.getElementById("tbody_invitepj");
        if (!tbodyInvitePj) return;
        // 현재는 원본 HTML에 있는 임시 tr>th 구조를 그대로 두거나, 비워두거나,
        // "초대받은 프로젝트가 없습니다"와 같은 메시지를 표시할 수 있습니다.
        // API 연동은 다음 단계에서 진행합니다.
        tbodyInvitePj.innerHTML = '<tr><th>초대받은 프로젝트가 없습니다.</th></tr>'; // 비워두거나 메시지 표시
    }

    async function acceptInvitation(projectId) {
        alert(`프로젝트 ${projectId} 초대를 수락합니다. (API 연동 필요)`);
    }

    async function rejectInvitation(projectId) {
        alert(`프로젝트 ${projectId} 초대를 거절합니다. (API 연동 필요)`);
    }

    // DOMContentLoaded 이벤트 리스너 (기존 로직 유지 및 loadMyProjects, loadPendingInvitations 호출 추가)
    document.addEventListener('DOMContentLoaded', () => {
        const newpjBtn = document.getElementById('addnewproject'); // 원본 HTML의 ID 사용
        const modal = document.querySelector('.modal_nw');

        if (modal) {
            closeModal(modal);
        }

        if (newpjBtn) {
            newpjBtn.addEventListener('click', () => {
                // 모달 내 입력 필드 초기화 (선택적)
                const titleInput = document.getElementById("projectTitle_modal");
                const descriptionInput = document.getElementById("projectDescription_modal");
                if(titleInput) titleInput.value = "";
                if(descriptionInput) descriptionInput.value = "";

                if (modal) {
                    modal.showModal();
                    Watchdiv3('1');
                }
            });
        }

        loadMyProjects();
        loadPendingInvitations(); // 현재는 임시 데이터 또는 비어있음

        // 원본 HTML에 있던 말줄임표 스크립트 위치 (수정 없음)
        document.querySelectorAll('.lenCut_container').forEach(container => {
            const spanText = container.querySelector(".lenCut");
            const spanTextE = container.querySelector(".lenCutE");
            const spanTextN = container.querySelector(".lenCutN");
            const tooltip = container.querySelector('.tooltip1'); // 각 container 내부에서 tooltip 찾기

            if (spanText && tooltip) {
                const spanTextOriginal = spanText.textContent;
                if (spanTextOriginal.length > 15) { // 원본 HTML의 길이 기준에 따름 (예시)
                    spanText.textContent = spanTextOriginal.slice(0, 15) + "...";
                    spanText.addEventListener('mouseenter', function () {
                        tooltip.style.display = 'block';
                        tooltip.textContent = spanTextOriginal;
                    });
                    spanText.addEventListener('mouseleave', function () {
                        tooltip.style.display = 'none';
                    });
                }
            }

            if (spanTextE && tooltip){
                const spanTextOriginalE = spanTextE.textContent;
                if (spanTextOriginalE.length > 12) { // 원본 HTML의 길이 기준에 따름 (예시)
                    spanTextE.textContent = spanTextOriginalE.slice(0, 12) + "...";
                    spanTextE.addEventListener('mouseenter', function () {
                        tooltip.style.display = 'block';
                        tooltip.textContent = spanTextOriginalE;
                    });
                    spanTextE.addEventListener('mouseleave', function () {
                        tooltip.style.display = 'none';
                    });
                }
            }

            if (spanTextN && tooltip){
                const spanTextOriginalN = spanTextN.textContent;
                if (spanTextOriginalN.length > 8) { // 원본 HTML의 길이 기준에 따름 (예시)
                    spanTextN.textContent = spanTextOriginalN.slice(0, 8) + "...";
                    spanTextN.addEventListener('mouseenter', function () {
                        tooltip.style.display = 'block';
                        tooltip.textContent = spanTextOriginalN;
                    });
                    spanTextN.addEventListener('mouseleave', function () {
                        tooltip.style.display = 'none';
                    });
                }
            }
        });
    });


    // 프로젝트 생성창 (이름, 설명 - 유저초대 전환)
    function Watchdiv3(i) {
        const sections = ["1", "2"];
        sections.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.style.display = (id === i) ? 'block' : 'none';
            }
        });
  
        const button = document.querySelectorAll('.button_friend');
        button.forEach((btn,index) => {
            if((index + 1).toString() === i){
                btn.classList.add('active');
            }
            else{
                btn.classList.remove('active');
            }
        });
    }
    window.addEventListener('load', () => Watchdiv3('1'));
    window.Watchdiv3 = Watchdiv3;


</script>
</html>